<%- include('partials/header') %>

<style>
    /* Responsive table styles for mobile */
    @media screen and (max-width: 768px) {
        .table-responsive-stack {
            display: block;
            width: 100%;
        }
        .table-responsive-stack thead {
            display: none; /* Hide table headers on mobile */
        }
        .table-responsive-stack tr {
            display: block;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
        }
        .table-responsive-stack td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .75rem;
            border-top: 1px solid #dee2e6;
            text-align: right; /* Align data to the right */
        }
        .table-responsive-stack tr td:first-child {
            border-top: none;
        }
        .table-responsive-stack td::before {
            content: attr(data-label); /* Use data-label for the heading */
            font-weight: bold;
            text-align: left; /* Align label to the left */
            padding-right: 1rem;
        }
    }
</style>

<div class="container mt-5">
    <h1 class="mb-4">Permit Dashboard</h1>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-responsive-stack">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Permit #</th>
                    <th scope="col">Status</th>
                    <th scope="col">Type</th>
                    <th scope="col">Valid From</th>
                    <th scope="col">Valid To</th>
                    <th scope="col">Holder</th>
                    <th scope="col" style="width: 20%;">Vehicle(s)</th>
                </tr>
            </thead>
            <tbody>
                <% permits.forEach(permit => { %>
                    <tr>
                        <td data-label="Permit #"><%= permit.permitNo %></td>
                        <td data-label="Status"><span class="badge <%= permit.status === 'Active' ? 'bg-success' : 'bg-danger' %>"><%= permit.status %></span></td>
                        <td data-label="Type"><%= permit.description %></td>
                        <td data-label="Valid From"><%= permit.validFrom %></td>
                        <td data-label="Valid To"><%= permit.validTo %></td>
                        <td data-label="Holder"><%= permit.holder %></td>
                        <td data-label="Vehicle(s)">
                            <div class="input-group">
                                <select class="form-select" id="plate-select-<%= permit.permitNo %>" data-current-plate="<%= permit.vehicle %>">
                                    <% if (permit.availablePlates.length === 0) { %>
                                        <option><%= permit.vehicle %></option>
                                    <% } else { %>
                                        <% permit.availablePlates.forEach(plateInfo => { %>
                                            <option value="<%= plateInfo.plate %>" <%= permit.vehicle === plateInfo.plate ? 'selected' : '' %>><%= plateInfo.plate %> - <%= plateInfo.name %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" onclick="updatePlate(this, `<%= permit.detailPageUrl %>`)">
                                    Change
                                </button>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>

</div>

<script>
    function updatePlate(button, detailPageUrl) {
        const selectElement = button.previousElementSibling;
        const plateToActivate = selectElement.value;
        const currentPlate = selectElement.dataset.currentPlate;

        if (plateToActivate === currentPlate) {
            alert('This plate is already active.');
            return;
        }
        
        // Construct the URL for the status page with all necessary info
        const url = `/update-status?detailPageUrl=${encodeURIComponent(detailPageUrl)}&plateToActivate=${encodeURIComponent(plateToActivate)}&currentPlate=${encodeURIComponent(currentPlate)}`;
        // Redirect the user to the status page
        window.location.href = url;
    }
</script>

<%- include('partials/footer') %>